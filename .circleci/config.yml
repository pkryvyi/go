version: 2
jobs:
    build:
        working_directory: /go/src/github.com/pkryvyi/go
        environment:
            PROJECT_ID: webapp-207620
            CLUSTER_NAME: webapp207620-cluster
            COMPUTE_ZONE: europe-west1-b
    #As specified in Deployment.yml
            DEPLOYMENT_NAME: webapp-dep
            CONTAINER_NAME: webappp
        docker:
            #- image: circleci/golang:1.9
            - image: google/cloud-sdk
        steps:
            - setup_remote_docker
            - checkout
            #- run: sudo service docker start
            - run: 
                name: Build a Docker image and use the Github commit hash ($CIRCLE_SHA1) as the tag
                #command: docker build -t webapppp .
                command: docker build -t eu.gcr.io/${PROJECT_ID}/node-app:$CIRCLE_SHA1 .

            - run: echo $SERVICE_KEY > key.txt
        # Decode the Service Account
            - run: base64 -i key.txt -d > ${HOME}/gcloud-service-key.json
        # Authenticate CircleCI with the service account file
            - run: sudo /opt/google-cloud-sdk/bin/gcloud auth activate-service-account ${ACCOUNT_ID} --key-file ${HOME}/gcloud-service-key.json 
                #gcloud config set account ${ACCOUNT_ID} 
                #gcloud auth configure-docker

            - run:
                name: Push the Image to the GCP Container Registry
                #command: /opt/google-cloud-sdk/bin/gcloud docker -- push eu.gcr.io/${PROJECT_ID}/node-app:$CIRCLE_SHA1
                command: gcloud docker -- push eu.gcr.io/${PROJECT_ID}/node-app:$CIRCLE_SHA1
           # - run:
           #  
           #     name: Update the default image for the deployment
           #     command: sudo /opt/google-cloud-sdk/bin/kubectl set image deployment/${DEPLOYMENT_NAME} ${CONTAINER_NAME}=eu.gcr.io/${PROJECT_ID}/node-app:$CIRCLE_SHA1

#workflows:
 # version: 2
  #build_and_test:
   # jobs:
    #  - build


